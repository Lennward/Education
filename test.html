<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell & Protein Analytics Interactive Course - Module 3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }
        .sidebar-link {
            transition: all 0.3s ease;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: #4a5568; /* gray-700 */
            color: #facc15; /* yellow-400 */
            transform: translateX(5px);
        }
        .module-content h2 {
            font-size: 1.75rem; 
            font-weight: 600; 
            color: #1e3a8a; /* blue-800 */
            margin-bottom: 1rem;
            border-bottom: 2px solid #3b82f6; /* blue-500 */
            padding-bottom: 0.5rem;
        }
        .module-content h3 {
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #1d4ed8; /* blue-700 */
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .module-content > h4, .module-content .styled-h4 {
            font-size: 1.15rem; 
            font-weight: 600;   
            color: #1e40af;     
            background-color: rgba(219, 234, 254, 0.6); 
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem; 
            display: inline-block; 
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid #3b82f6; 
        }

        .module-content p, .module-content ul, .module-content ol, .module-content table { 
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #374151; 
        }
        .module-content ul, .module-content ol { 
            margin-left: 1.5rem;
        }
        .module-content ol.list-decimal { 
            list-style-type: decimal;
        }
        .module-content .formula {
            font-family: 'Times New Roman', Times, serif; 
            font-size: 1.1em;
            color: #1e40af; 
            background-color: #f0f9ff; 
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e0f2fe; 
            display: inline-block; 
            margin-top: 0.25rem;
            margin-bottom: 0.75rem;
        }
        .interactive-box, .practice-problem-box { 
            background-color: #eff6ff; 
            border: 1px solid #bfdbfe; 
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .interactive-box h4, .practice-problem-box h4 { 
            font-size: 1.1rem !important;   
            font-weight: 600 !important;    
            color: #1e40af !important;      
            background-color: transparent !important; 
            padding: 0 !important;             
            border-radius: 0 !important;         
            display: block !important;           
            margin-top: 0 !important;                  
            margin-bottom: 1rem !important; 
            border-left: none !important;         
        }
        .quiz-question {
            background-color: #f9fafb; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .quiz-option {
            display: block;
            width: 100%; 
            background-color: #fff;
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left; 
        }
        .quiz-option:hover {
            border-color: #3b82f6; 
            background-color: #eff6ff; 
        }
        .quiz-option.correct, .practice-problem-box .correct-answer { 
            background-color: #d1fae5 !important; 
            border-color: #10b981 !important; 
            color: #065f46 !important; 
        }
        .quiz-option.incorrect, .practice-problem-box .incorrect-answer { 
            background-color: #fee2e2 !important; 
            border-color: #ef4444 !important; 
            color: #991b1b !important; 
        }
        .feedback-message, .practice-feedback { 
            margin-top: 0.5rem;
            font-weight: 500;
        }
        .calculator input, .calculator select, .practice-problem-box input { 
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            box-sizing: border-box; 
        }
        .calculator button, .practice-problem-box button { 
            background-color: #3b82f6; 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
            border: none; 
        }
        .calculator button:hover, .practice-problem-box button:hover { 
            background-color: #2563eb; 
        }
        .flex.h-screen {
            display: flex;
            height: 100vh;
        }
        #sidebar {
            flex-shrink: 0; 
        }
        #main-content {
            flex-grow: 1; 
        }
        .solution-details { 
            font-size: 0.9rem;
            color: #4b5563; 
            background-color: #f9fafb; 
            border-left: 3px solid #3b82f6; 
            padding: 0.75rem;
            margin-top: 0.75rem;
            border-radius: 0.25rem;
        }

        .plasmid-info-box, .media-component-info-box { 
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
        }

        .media-component-button { 
            background-color: #93c5fd; 
            border: 1px solid #60a5fa; 
        }
        .media-component-button:hover {
            background-color: #60a5fa; 
        }
        .media-component-button.selected {
            background-color: #3b82f6; 
            color: white;
            font-weight: bold;
        }
        .highlight-note {
            background-color: #fef9c3; /* Tailwind yellow-100 */
            border-left: 4px solid #facc15; /* Tailwind yellow-400 */
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .highlight-note p {
            margin-bottom: 0 !important; 
        }
        .goal-box-clickable { 
            background-color: #e0f2fe; 
            border: 1px solid #7dd3fc; 
            border-radius: 0.5rem; 
            padding: 1rem;
            text-align: left; 
            min-height: 60px; 
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .goal-box-clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .goal-box-clickable strong {
            color: #0c4a6e; 
            font-size: 1.05em;
            margin-bottom: 0.5rem;
            display: block; 
        }
        .goal-detail {
            /* Initially hidden, JS will toggle */
        }

        /* Accordion Styles for Protocol */
        .accordion-item {
            border: 1px solid #dbeafe; /* Tailwind blue-200 */
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 0.5rem;
            background-color: #fff; /* White background for item */
        }
        .accordion-header {
            background-color: #eff6ff; /* Tailwind blue-50 */
            padding: 0.75rem 1rem;
            width: 100%;
            text-align: left;
            font-weight: 600; /* semibold */
            color: #1e3a8a; /* blue-800 */
            border: none;
            border-radius: 0.375rem 0.375rem 0 0; /* Rounded top corners */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: #dbeafe; /* Tailwind blue-200 */
        }
        .accordion-header.active {
            background-color: #bfdbfe; /* Tailwind blue-300 */
             border-radius: 0.375rem 0.375rem 0 0; /* Keep top corners rounded */
        }
        .accordion-header .step-number {
            margin-right: 0.5rem;
            font-size: 0.9em;
        }
         .accordion-header .step-title {
            flex-grow: 1;
        }
        .accordion-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(45deg); /* '+' to 'x' like symbol */
        }
        .accordion-content {
            padding: 1rem;
            border-top: 1px solid #dbeafe; /* blue-200 */
            background-color: #f9fafb; /* gray-50 for content area */
            border-radius: 0 0 0.375rem 0.375rem; /* Rounded bottom corners */
        }
        .accordion-content h5 { /* Styling for sub-headings within protocol steps */
            font-size: 1rem;
            font-weight: 600;
            color: #1d4ed8; /* blue-700 */
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .accordion-content ul {
            margin-left: 1rem; /* Indent lists within steps */
        }

    </style>
</head>
<body class="bg-gray-200">

    <div class="flex h-screen font-inter">
        <nav id="sidebar" class="w-64 sm:w-72 bg-slate-800 text-slate-100 p-4 sm:p-6 space-y-3 overflow-y-auto shadow-lg">
            <h1 class="text-xl sm:text-2xl font-bold text-yellow-400 mb-6 border-b-2 border-yellow-500 pb-2">Molecular Explorer</h1>
        </nav>

        <main id="main-content" class="flex-1 p-4 sm:p-6 md:p-10 bg-slate-50 overflow-y-auto">
            <div id="welcome-message" class="text-center p-6 sm:p-10 bg-white rounded-lg shadow-md" style="display: block;"> 
                <h2 class="text-2xl sm:text-3xl font-semibold text-blue-700 mb-4">Welcome to the Interactive Cell & Protein Analytics Course!</h2>
                <p class="text-base sm:text-lg text-gray-600 mb-6">Select a module from the sidebar to begin your learning journey.</p>
                <img src="Logo_Heidelberg.svg" alt="Heidelberg Logo" class="block mx-auto h-16 w-auto">
            </div>
        </main>
    </div>

    <script>
        console.log("SCRIPT EXECUTION STARTED: HTML parsing should be complete or near complete.");

        // Make calculatePlasmidVolume global for HTML onclick
        window.calculatePlasmidVolume = function() {
            const desiredMassEl = document.getElementById('desired_mass_pg');
            const stockConcEl = document.getElementById('stock_conc_pg');
            const resultContainerEl = document.getElementById('plasmid-volume-result-container');
            const resultEl = document.getElementById('plasmid-volume-result');

            if (!desiredMassEl || !stockConcEl || !resultContainerEl || !resultEl) {
                console.error("Plasmid calculator elements missing for Module 3.");
                if (resultEl) resultEl.innerHTML = "<span class='text-red-600'>Calculator element error.</span>";
                if (resultContainerEl) resultContainerEl.classList.remove('hidden');
                return;
            }

            const desiredMassUg = parseFloat(desiredMassEl.value); 
            const stockConcNgUl = parseFloat(stockConcEl.value); 

            resultContainerEl.classList.add('hidden');
            resultEl.innerHTML = "";

            if (isNaN(desiredMassUg) || isNaN(stockConcNgUl) || desiredMassUg <= 0 || stockConcNgUl <= 0) {
                resultEl.innerHTML = "<span class='text-red-600'>Please enter valid positive numbers for mass and concentration.</span>";
                resultContainerEl.classList.remove('hidden');
                return;
            }
            const volumeUl = (desiredMassUg * 1000) / stockConcNgUl;
            resultEl.innerHTML = `Required Volume: <strong>${volumeUl.toFixed(3)} &micro;L</strong>`;
            resultContainerEl.classList.remove('hidden');
        };


        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM FULLY LOADED AND PARSED.");

            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const welcomeMessage = document.getElementById('welcome-message');

            console.log("Global DOM elements after DOMContentLoaded: Sidebar:", sidebar, "MainContent:", mainContent, "WelcomeMessage:", welcomeMessage);

            if (!sidebar || !mainContent || !welcomeMessage) {
                console.error("CRITICAL ERROR: One or more essential page elements (sidebar, main-content, welcome-message) are missing from the DOM. Script cannot proceed.");
                if (mainContent) mainContent.innerHTML = "<p class='text-red-500 p-4'>Critical page error: Essential elements like sidebar or main content area are missing. Check HTML structure.</p>";
                else document.body.innerHTML = "<p class='text-red-500 p-4'>Critical page error: Body content cannot be initialized.</p>";
                return; 
            }
            console.log("All essential global DOM elements found.");

            const modulesData = [
                {
                    id: "module3",
                    title: "Module 3: Cellular Alchemy: The Art of Transfection",
                    content: () => `
                        <div class="module-content">
                            <h2>Module 3: Cellular Alchemy: The Art of Transfection</h2>
                            <p>Welcome to the fascinating world of transfection! In this module, you'll learn how to introduce foreign genetic material into cells, a cornerstone technique in molecular biology that allows us to study gene function, produce proteins, and much more. It's like giving cells a new set of instructions!</p>
                            
                            <h3>I. Module Overview & Learning Objectives</h3>
                            <p>This module will guide you through the principles and practical steps of transfecting eukaryotic cells, focusing on the calcium phosphate method.</p>

                            <h3>II. Content Sections</h3>
                            
                            <h4 class="styled-h4">A. Introduction to Transfection</h4>
                            <p><strong>What is Transfection?</strong><br>
                            Transfection is a powerful biotechnological process used to introduce foreign nucleic acids – most commonly plasmid DNA – into eukaryotic cells. This allows scientists to manipulate the genetic makeup of cells in a controlled manner.</p>
                            
                            <div class="interactive-box">
                                <h4>Goals of Transfection</h4>
                                <p class="text-sm mb-3">The primary goals of transfection are diverse. Click on each goal below to learn more about its specific purpose:</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="goal-box-clickable" data-goal="expression">
                                        <strong>Gene Expression</strong>
                                        <div class="goal-detail text-sm text-gray-700 hidden mt-2">
                                            Introducing a gene to produce a specific protein (e.g., a fluorescent marker like GFP, or a therapeutic protein). This allows studying protein function, localization, or producing it in larger quantities.
                                        </div>
                                    </div>
                                    <div class="goal-box-clickable" data-goal="silencing">
                                        <strong>Gene Silencing/Knockdown</strong>
                                        <div class="goal-detail text-sm text-gray-700 hidden mt-2">
                                            Introducing constructs (like siRNA or shRNA) to reduce or eliminate the expression of a specific endogenous gene. This is crucial for understanding gene function by observing the effects of its absence.
                                        </div>
                                    </div>
                                    <div class="goal-box-clickable" data-goal="reporter">
                                        <strong>Reporter Assays</strong>
                                        <div class="goal-detail text-sm text-gray-700 hidden mt-2">
                                            Studying the activity of promoters or other regulatory DNA elements by linking them to a reporter gene (e.g., luciferase or GFP). The expression level of the reporter indicates the activity of the element.
                                        </div>
                                    </div>
                                    <div class="goal-box-clickable" data-goal="production">
                                        <strong>Protein Production</strong>
                                        <div class="goal-detail text-sm text-gray-700 hidden mt-2">
                                            Using cells as bio-factories to produce large quantities of a specific recombinant protein for research, therapeutic, or industrial purposes.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <p><strong>Transient vs. Stable Transfection:</strong><br>
                            Transfection can be either transient or stable:
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Transient Transfection:</strong> The introduced nucleic acid (e.g., plasmid) enters the cell and is expressed for a limited period (typically 24-96 hours). It is not integrated into the host cell's genome and is eventually lost or diluted out as cells divide. This is useful for rapid gene expression studies.</li>
                                <li><strong>Stable Transfection:</strong> The introduced nucleic acid is integrated into the host cell's genome. This results in long-term, stable expression of the gene, which is passed on to daughter cells during cell division. Creating stable cell lines requires selection methods (e.g., using antibiotic resistance markers).</li>
                            </ul>
                            </p>
                            <img src="placeholder_transfection_overview.svg" alt="Schematic of plasmid DNA entering a cell and leading to protein expression" class="my-4 rounded-lg shadow-md mx-auto block max-w-full sm:max-w-lg w-auto bg-gray-200 p-4" onerror="this.onerror=null; this.src='https://placehold.co/500x300/e2e8f0/4a5568?text=Placeholder:+Transfection+Overview'; this.alt='Placeholder: Transfection Overview';">

                            <h4 class="styled-h4">B. Overview of Transfection Methods</h4>
                            <p><strong>The Variety of Methods:</strong><br>
                            There are numerous ways to get nucleic acids into cells, broadly categorized as:
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Chemical Methods:</strong> These involve using reagents that complex with DNA and facilitate its entry into cells. Examples include:
                                    <ul class="list-circle list-inside ml-4">
                                        <li><strong>Calcium Phosphate Precipitation:</strong> The method we'll use! DNA is mixed with calcium chloride and phosphate buffer, forming fine DNA-calcium phosphate co-precipitates that are taken up by cells via endocytosis. It's cost-effective and works well for many adherent cell lines like HEK293.</li>
                                        <li><strong>Lipid-based (Lipofection):</strong> Cationic lipids form complexes (lipoplexes) with negatively charged DNA, which then fuse with the cell membrane or are endocytosed. Reagents like Lipofectamine™ are common.</li>
                                        <li><strong>Cationic Polymers:</strong> Polymers like Polyethylenimine (PEI) or dendrimers bind DNA and form polyplexes, which are then endocytosed.</li>
                                    </ul>
                                </li>
                                <li><strong>Physical Methods:</strong> These use physical force to create transient pores in the cell membrane.
                                    <ul class="list-circle list-inside ml-4">
                                        <li><strong>Electroporation:</strong> Cells are exposed to a brief electrical pulse, creating temporary pores for DNA entry. Very efficient for many cell types, including those hard to transfect by chemical means.</li>
                                        <li><strong>Microinjection:</strong> DNA is directly injected into the cytoplasm or nucleus using a fine glass micropipette. Precise but low-throughput.</li>
                                        <li><strong>Gene Gun (Biolistics):</strong> DNA-coated gold or tungsten particles are shot into cells or tissues.</li>
                                    </ul>
                                </li>
                                <li><strong>Viral Methods (Transduction):</strong> Recombinant viruses (e.g., lentiviruses, adenoviruses, AAV) are used as vectors to deliver genetic material. Often very high efficiency, even in primary cells and in vivo, and can be used for stable integration.</li>
                            </ul>
                            In this course, we will focus on the **Calcium Phosphate Precipitation** method due to its effectiveness with HEK293 cells and its historical significance.
                            </p>
                            <div class="interactive-box">
                                <h4>Interactive Box 1: The Agony of Choice: Which Method for Which Purpose?</h4>
                                <p class="text-sm mb-2">Scenario: Imagine you want to express proteins quickly and cost-effectively in robust HEK293 cells. Which of the following methods would be most suitable for this project and our course?</p>
                                <div id="transfection-method-choice-quiz" class="space-y-1">
                                    </div>
                                <div id="transfection-method-choice-feedback" class="feedback-message text-xs mt-2 p-1.5 rounded-md hidden"></div>
                            </div>

                            <h4 class="styled-h4">C. In Detail: Calcium Phosphate Transfection</h4>
                            <p><strong>The Principle – Magic with Calcium and Phosphate:</strong><br>
                            The calcium phosphate method relies on a simple chemical trick. Negatively charged plasmid DNA is mixed with calcium chloride (CaCl₂). When a phosphate-buffered saline solution (like 2x BBS - HEPES Buffered Saline) is added, insoluble calcium phosphate-DNA co-precipitates form. These fine, crystalline particles settle onto adherent cells. Cells naturally take up these particles through endocytosis (a process where the cell membrane engulfs external material). Once inside the cell, some of the DNA escapes the endosomes, makes its way to the nucleus, and can then be transcribed and translated by the cell's machinery to produce the desired protein (e.g., GFP or your FLAG-tagged protein).</p>

                            <p><strong>Our Tools and Ingredients:</strong>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Cells:</strong> HEK293 cells (Human Embryonic Kidney cells, adherent).</li>
                                <li><strong>Plasmids:</strong>
                                    <ul class="list-circle list-inside ml-4">
                                        <li>pH2B-GFP (Concentration: 682.3 ng/µL - *confirm with your stock tube label*)</li>
                                        <li>pRKV-FLAG (Concentration: 1015 ng/µL - *confirm with your stock tube label*)</li>
                                    </ul>
                                </li>
                                <li><strong>Main Reagents:</strong>
                                    <ul class="list-circle list-inside ml-4">
                                        <li>0.25 M CaCl₂ solution</li>
                                        <li>2x BBS (Buffered Saline Solution, typically HEPES-buffered, pH is critical, usually around 7.05-7.12)</li>
                                    </ul>
                                </li>
                            </ul>
                            </p>
                            <img src="placeholder_calcium_phosphate_mechanism.svg" alt="Schematic of calcium phosphate transfection mechanism" class="my-4 rounded-lg shadow-md mx-auto block max-w-full sm:max-w-lg w-auto bg-gray-200 p-4" onerror="this.onerror=null; this.src='https://placehold.co/500x300/e2e8f0/4a5568?text=Placeholder:+CaPi+Mechanism'; this.alt='Placeholder: CaPi Mechanism';">

                            <div class="styled-h4">The Protocol – Step by Step to Success:</div>
                            <p class="text-sm italic">The following protocol is for transfecting <strong>one well</strong> of a 24-well plate. Remember to scale up your calculations for the total number of wells you plan to transfect for each plasmid, and always prepare a little extra (e.g., 10%) to account for pipetting inaccuracies!</p>
                            
                            <div class="highlight-note">
                                <p><strong>Crucial Reminder:</strong> Always prepare all solutions for the required number of wells PLUS 10% extra volume to account for pipetting errors!</p>
                            </div>

                            <div id="protocol-accordion" class="space-y-2 my-6">
                                </div>


                            <h4 class="styled-h4">D. Important Tips & Troubleshooting Corner</h4>
                            <p>Successful transfection is an art as much as a science! Here are some key factors and common pitfalls:</p>
                            <ul class="list-disc list-inside ml-4">
                                <li><strong>Cell Confluency:</strong> Cells should be actively dividing and not too sparse or too dense. For HEK293 cells with CaPi, a confluency of 50-70% at the time of transfection is often optimal. Overly confluent cells transfect poorly.</li>
                                <li><strong>DNA Quality & Quantity:</strong> Use high-purity plasmid DNA (e.g., endotoxin-free). The amount of DNA needs to be optimized; too little results in low efficiency, too much can be toxic.</li>
                                <li><strong>pH of BBS:</strong> This is CRITICAL for the calcium phosphate method. The pH of the 2x BBS solution directly influences the size and quality of the precipitate. Even slight deviations can drastically affect efficiency. Typically, a pH between 7.05 and 7.12 is required.</li>
                                <li><strong>Mixing and Incubation:</strong> Gentle mixing and correct incubation times for precipitate formation are key.</li>
                                <li><strong>Pipetting Skills:</strong> Accuracy, especially with small volumes of plasmids and reagents, is paramount.</li>
                                <li><strong>Cleanliness and Sterility:</strong> As always in cell culture, maintain strict aseptic technique to avoid contamination, which can ruin your experiment.</li>
                            </ul>
                            <div class="interactive-box">
                                <h4>Interactive Box 4: What Went Wrong? – Transfection Troubleshooting</h4>
                                <div id="transfection-troubleshooting-quiz">
                                    </div>
                            </div>

                            <h4 class="styled-h4">E. Outlook</h4>
                            <p>Congratulations, you've theoretically performed a transfection! What's next? After sufficient incubation time (usually 24-48 hours for transient expression), the real fun begins: analyzing your results! In a subsequent module or lab session, you would typically:</p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Observe cells under a fluorescence microscope to detect GFP expression (green fluorescence).</li>
                                <li>Perform immunofluorescence staining to detect the FLAG-tagged protein (if pRKV-FLAG was used).</li>
                                <li>Calculate transfection efficiency (e.g., percentage of GFP-positive cells).</li>
                                <li>Proceed with downstream experiments, such as protein extraction for Western blotting, or functional assays.</li>
                            </ul>
                        </div>
                    `,
                    quiz: [
                        {
                            question: "What is the primary purpose of adding 2x BBS in the calcium phosphate transfection method?",
                            options: ["To provide nutrients to the cells", "To permeabilize the cell membrane", "To form a DNA-calcium phosphate co-precipitate", "To select for transfected cells"],
                            answer: "To form a DNA-calcium phosphate co-precipitate",
                            type: "mcq",
                            explanation: "2x BBS (Buffered Saline Solution) provides the phosphate ions that react with calcium chloride and DNA to form the fine precipitate that cells can take up."
                        },
                        {
                            question: "True or False: For optimal calcium phosphate transfection, cells should ideally be 100% confluent.",
                            options: ["True", "False"],
                            answer: "False",
                            type: "tf",
                            explanation: "Cells should be actively dividing and typically at a confluency of 50-70% for efficient calcium phosphate transfection. 100% confluency often leads to lower efficiency."
                        },
                        {
                            question: "Which of the following is NOT a critical factor for successful calcium phosphate transfection?",
                            options: ["pH of the BBS solution", "Quality and quantity of plasmid DNA", "Vigorous vortexing after adding BBS", "Cell health and confluency"],
                            answer: "Vigorous vortexing after adding BBS",
                            type: "mcq",
                            explanation: "Vigorous vortexing after adding BBS can lead to large, irregular precipitates and shear DNA, reducing transfection efficiency. Gentle mixing by inversion is recommended."
                        }
                    ],
                    init: () => {
                        console.log("Module 3 init function started.");
                        // Initialize "Goals of Transfection" interactive boxes
                        const goalBoxes = document.querySelectorAll('.goal-box-clickable');
                        console.log("Found goal boxes:", goalBoxes.length);
                        goalBoxes.forEach(box => {
                            box.addEventListener('click', () => {
                                const detail = box.querySelector('.goal-detail');
                                if (detail) {
                                    const isHidden = detail.classList.contains('hidden');
                                    document.querySelectorAll('.goal-detail').forEach(otherDetail => {
                                        if (otherDetail !== detail) {
                                            otherDetail.classList.add('hidden');
                                            otherDetail.closest('.goal-box-clickable').classList.remove('ring-2', 'ring-sky-500');
                                        }
                                    });
                                    if (isHidden) {
                                        detail.classList.remove('hidden');
                                        box.classList.add('ring-2', 'ring-sky-500');
                                    } else {
                                        detail.classList.add('hidden');
                                        box.classList.remove('ring-2', 'ring-sky-500');
                                    }
                                }
                            });
                        });

                        // Initialize Interactive Box 1: Transfection Method Choice
                        const methodChoiceContainer = document.getElementById('transfection-method-choice-quiz');
                        const methodChoiceFeedback = document.getElementById('transfection-method-choice-feedback');
                        if (methodChoiceContainer && methodChoiceFeedback) {
                            console.log("Initializing Transfection Method Choice quiz.");
                            const methodQuizData = {
                                options: ["Lipofection (e.g., Lipofectamine)", "Electroporation", "Calcium Phosphate Precipitation", "Viral Transduction (e.g., with lentiviruses)"],
                                answer: "Calcium Phosphate Precipitation",
                                feedback_correct: "Exactly! The calcium phosphate method is an established, cost-effective method well-suited for transfecting adherent cells like HEK293 and is ideal for our course objectives.",
                                feedback_incorrect: "Not quite. Think again about which method is well-suited for robust, adherent cells and a limited budget. For example, while viral transduction is very efficient, it's more complex and costly for routine experiments like this. Lipofection is also common but can be more expensive than CaPi. Electroporation is efficient but requires specialized equipment."
                            };
                            methodChoiceContainer.innerHTML = ''; 
                            methodQuizData.options.forEach(optText => {
                                const optButton = document.createElement('button');
                                optButton.className = 'quiz-option text-xs sm:text-sm';
                                optButton.textContent = optText;
                                optButton.onclick = () => {
                                    methodChoiceContainer.querySelectorAll('.quiz-option').forEach(btn => {
                                        btn.disabled = true;
                                        btn.classList.remove('correct', 'incorrect');
                                    });
                                    methodChoiceFeedback.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                                    if (optText === methodQuizData.answer) {
                                        optButton.classList.add('correct');
                                        methodChoiceFeedback.innerHTML = `<strong>Correct!</strong> ${methodQuizData.feedback_correct}`;
                                        methodChoiceFeedback.classList.add('bg-green-100', 'text-green-700');
                                    } else {
                                        optButton.classList.add('incorrect');
                                        methodChoiceFeedback.innerHTML = `<strong>Not quite.</strong> ${methodQuizData.feedback_incorrect}`;
                                        methodChoiceFeedback.classList.add('bg-red-100', 'text-red-700');
                                        methodChoiceContainer.querySelectorAll('.quiz-option').forEach(btn => {
                                            if (btn.textContent === methodQuizData.answer) btn.classList.add('correct');
                                        });
                                    }
                                    methodChoiceFeedback.classList.remove('hidden');
                                };
                                methodChoiceContainer.appendChild(optButton);
                            });
                        } else {
                            console.warn("Transfection method choice elements not found.");
                        }
                        
                        // Initialize Interactive Box 4: Troubleshooting Quiz
                        const troubleshootingContainer = document.getElementById('transfection-troubleshooting-quiz');
                        if (troubleshootingContainer) {
                            console.log("Initializing Troubleshooting quiz.");
                            const troubleshootingQuizData = [
                                {
                                    question: "Your cells look very unhappy after transfection, and many have detached. What could be a primary reason related to the CaPi method?",
                                    options: ["Too little DNA was used", "The precipitates were too fine or incubated for too short a time", "The pH of the BBS was too high, leading to coarse, toxic precipitates, or precipitates were left on cells too long", "Cells were not confluent enough"],
                                    answer: "The pH of the BBS was too high, leading to coarse, toxic precipitates, or precipitates were left on cells too long",
                                    explanation: "Coarse CaPi precipitates formed due to incorrect pH or overly long incubation with cells can be quite toxic, leading to cell stress and detachment."
                                },
                                {
                                    question: "You see hardly any GFP-positive cells 24-48 hours post-transfection. Which is a common critical factor to check first for CaPi transfections?",
                                    options: ["The incubator temperature was 36°C instead of 37°C", "The pH of the 2x BBS solution was incorrect", "You used 0.5 µg of DNA instead of 0.3 µg", "The cells were only 50% confluent"],
                                    answer: "The pH of the 2x BBS solution was incorrect",
                                    explanation: "The pH of the BBS is extremely critical for forming the right kind of fine precipitate for efficient uptake. Incorrect pH is a very common reason for CaPi transfection failure."
                                }
                            ];
                            troubleshootingContainer.innerHTML = ''; 
                            troubleshootingQuizData.forEach((q, index) => {
                                const qDiv = document.createElement('div');
                                qDiv.className = 'quiz-question p-3 mb-2 bg-white rounded-md shadow-sm';
                                let optionsHtml = `<p class="font-medium mb-2 text-sm">${index + 1}. ${q.question}</p><div class="space-y-1">`;
                                q.options.forEach(optText => {
                                    optionsHtml += `<button class="quiz-option text-xs" data-question-index-ts="${index}" data-option-value-ts="${optText.replace(/"/g, '&quot;')}">${optText}</button>`;
                                });
                                optionsHtml += `</div><div class="feedback-message text-xs mt-1 p-1 rounded-md hidden"></div>`;
                                qDiv.innerHTML = optionsHtml;
                                troubleshootingContainer.appendChild(qDiv);
                            });

                            troubleshootingContainer.addEventListener('click', function(event) {
                                if (event.target.classList.contains('quiz-option') && event.target.dataset.questionIndexTs) {
                                    const selectedOptBtn = event.target;
                                    const qIndex = parseInt(selectedOptBtn.dataset.questionIndexTs);
                                    const qData = troubleshootingQuizData[qIndex];
                                    const feedbackEl = selectedOptBtn.closest('.quiz-question').querySelector('.feedback-message');
                                    const selectedVal = selectedOptBtn.dataset.optionValueTs;

                                    selectedOptBtn.parentElement.querySelectorAll('.quiz-option').forEach(btn => {
                                        btn.disabled = true;
                                        btn.classList.remove('correct', 'incorrect');
                                    });
                                    feedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');

                                    if (selectedVal === qData.answer) {
                                        selectedOptBtn.classList.add('correct');
                                        feedbackEl.innerHTML = `<strong>Correct!</strong> ${qData.explanation || ''}`;
                                        feedbackEl.classList.add('bg-green-100', 'text-green-700');
                                    } else {
                                        selectedOptBtn.classList.add('incorrect');
                                        feedbackEl.innerHTML = `<strong>Incorrect.</strong> Correct answer: ${qData.answer}. <br>${qData.explanation || ''}`;
                                        feedbackEl.classList.add('bg-red-100', 'text-red-700');
                                        selectedOptBtn.parentElement.querySelectorAll('.quiz-option').forEach(btn => {
                                            if (btn.dataset.optionValueTs === qData.answer) {
                                                btn.classList.add('correct');
                                            }
                                        });
                                    }
                                    feedbackEl.classList.remove('hidden');
                                }
                            });
                        } else {
                            console.warn("Troubleshooting quiz container not found.");
                        }
                        
                        // Initialize Protocol Accordion
                        const accordionContainer = document.getElementById('protocol-accordion');
                        if (accordionContainer) {
                            console.log("Protocol accordion container found. Initializing...");
                            const protocolSteps = [
                                { 
                                    title: "Prepare Solution & Add Plasmid", 
                                    content: `
                                        <ul class="list-disc list-inside ml-5 mt-1 text-sm space-y-1">
                                            <li>In a sterile 1.5 mL microcentrifuge tube (Eppendorf tube), add <strong>25 µL of 0.25 M CaCl₂</strong>.</li>
                                            <li>
                                                <strong>Add Plasmid DNA:</strong> Add <strong>0.3 - 0.5 µg</strong> of your desired plasmid (pH2B-GFP or pRKV-FLAG) to the CaCl₂.
                                                <div class="p-2 mt-1 bg-amber-50 border-l-4 border-amber-400 text-amber-700 text-xs rounded-r-md">
                                                    <p><strong>Attention, Pipetting Pros!</strong> Pipetting volumes less than 2 µL is highly inaccurate. If your calculated volume is too small, consider preparing a master mix for several wells or groups. For example, if you need 0.5 µL per well and are doing 4 wells, prepare a mix for 4.4 wells (4 wells + 10% extra), so 0.5 µL/well * 4.4 wells = 2.2 µL plasmid in a larger volume of CaCl₂.</p>
                                                    <p class="mt-1"><strong>Storage & Handling:</strong> Plasmids are stored in the freezer (next to the bacterial incubator, NOT the cell culture incubator!) in the green box labeled "iGEM". Always keep plasmids on ice when outside the freezer. The ice machine is located in room S0.311b (down the hall).</p>
                                                </div>
                                            </li>
                                        </ul>
                                    `
                                },
                                {
                                    title: "Plasmid Calculation & Small Volume Check",
                                    content: `
                                        <div class="interactive-box my-0 py-3"> <h4>Interactive Box 2: Plasmid Calculation Wizards Wanted!</h4>
                                            <p class="text-sm mb-2"><strong>Scenario 1: Volume Calculation</strong><br>You want to use 0.4 µg of Plasmid pH2B-GFP. Its stock concentration is 682.3 ng/µL. How many µL of the stock solution do you need?</p>
                                            <div class="calculator grid grid-cols-1 sm:grid-cols-2 gap-2 items-end mb-4">
                                                <div>
                                                    <label for="desired_mass_pg" class="block text-xs font-medium text-gray-700">Desired Mass (µg):</label>
                                                    <input type="number" id="desired_mass_pg" value="0.4" class="w-full mt-1 text-sm p-1">
                                                </div>
                                                <div>
                                                    <label for="stock_conc_pg" class="block text-xs font-medium text-gray-700">Stock Conc. (ng/µL):</label>
                                                    <input type="number" id="stock_conc_pg" value="682.3" class="w-full mt-1 text-sm p-1">
                                                </div>
                                                <div class="sm:col-span-2">
                                                    <button onclick="window.calculatePlasmidVolume()" class="w-full py-1.5 text-sm">Calculate Volume</button>
                                                </div>
                                            </div>
                                            <div id="plasmid-volume-result-container" class="p-2 bg-white rounded-md shadow text-sm hidden">
                                                <p id="plasmid-volume-result" class="font-semibold text-blue-700"></p>
                                            </div>

                                            <p class="text-sm mb-2 mt-4"><strong>Scenario 2: Handling Small Volumes</strong><br>The calculated volume from Scenario 1 is approximately 0.586 µL. Can this be pipetted accurately and directly with standard lab pipettes? (Select Yes or No)</p>
                                            <div id="small-volume-quiz" class="space-y-1 mb-2">
                                                <button class="quiz-option text-xs sm:text-sm" data-correct="false">Yes, it's fine.</button>
                                                <button class="quiz-option text-xs sm:text-sm" data-correct="true">No, it's too small for accurate direct pipetting.</button>
                                            </div>
                                            <div id="small-volume-feedback" class="feedback-message text-xs mt-1 p-1.5 rounded-md hidden"></div>
                                            <p class="text-xs text-gray-600 mt-1">If 'No', what's a good strategy? (Hint: Think master mix or dilution).</p>
                                        </div>
                                    `
                                },
                                { 
                                    title: "Optional: Dilute Plasmid Stock", 
                                    content: `<h5>Step 3: Optional Plasmid Dilution</h5><p class="text-sm"><em>(If you calculated a very small volume in the previous step that's difficult to pipette accurately, you might prepare a working dilution of your plasmid stock. Remember to calculate the dilution based on the total number of wells you need to transfect, plus about 10% extra to account for pipetting loss. Pipette an aliquot of your plasmid stock into a new sterile microcentrifuge tube, add the calculated amount of sterile ddH₂O (or dH₂O/VE-water - always add water first, then plasmid), flick the tube 5-10 times to mix, and briefly centrifuge (5-10 seconds) in a mini-centrifuge to collect the solution at the bottom. This step is often not necessary if you prepare a master mix for multiple wells.)</em></p>`
                                },
                                { 
                                    title: "Add 2x BBS", 
                                    content: `<h5>Step 4: The Magic Ingredient - Add 2x BBS</h5><p class="text-sm">Slowly, while gently vortexing or flicking the tube containing the CaCl₂-DNA mixture, add <strong>25 µL of 2x BBS</strong>. <br><strong class="text-red-600">Critical:</strong> Add BBS to the DNA/CaCl₂ mixture, not the other way around, for optimal precipitate formation.</p>`
                                },
                                { 
                                    title: "Mix Gently (Invert)", 
                                    content: `<h5>Step 5: Mix Gently</h5><p class="text-sm">Immediately after adding BBS, cap the tube and gently invert it 4-5 times to mix. <strong>DO NOT VORTEX</strong> at this stage, as it can shear the DNA or lead to suboptimal precipitate size. You should see a fine, milky precipitate forming.</p>`
                                },
                                { 
                                    title: "Incubate at Room Temp", 
                                    content: `<h5>Step 6: Patience Test (Precipitate Formation)</h5><p class="text-sm">Incubate the mixture for <strong>15 minutes at room temperature (RT)</strong>. This allows the DNA-calcium phosphate co-precipitates to form properly.</p>
                                            <div class="text-xs p-2 mt-1 bg-orange-50 border-l-4 border-orange-400 text-orange-700 rounded-r-md">
                                                <em>Note on Centrifugation: Your original protocol mentioned "1 Minute bei 2000rpm zentrifugieren". This step is not typical for standard CaPi protocols before adding to cells, as it might compact the precipitate too much, making it harder for cells to take up or even causing cell damage. Usually, the suspension is added directly after the 15-minute RT incubation. We will proceed without this centrifugation step unless specifically instructed otherwise for a modified protocol.</em>
                                            </div>`
                                },
                                { 
                                    title: "Add Suspension to Cells", 
                                    content: `<h5>Step 7: "Feed" the Cells</h5><p class="text-sm">After the 15-minute incubation, gently resuspend the fine precipitate by flicking the tube (if it has settled). Carefully add <strong>50 µL of this suspension dropwise</strong> onto the cells in one well of a 24-well plate. Distribute the drops evenly over the surface of the cell culture medium. The existing medium should remain on the cells.</p>`
                                },
                                { 
                                    title: "Conceptual Plate Layout", 
                                    content: `
                                        <div class="interactive-box my-0 py-3">
                                            <h4>Interactive Box 3: My Plate Layout – Who Gets What?</h4>
                                            <p class="text-sm mb-2">Plan your experiment! This is a conceptual representation. In the lab, you'd map out which wells get which plasmids or serve as controls.</p>
                                            <img src="placeholder_24_well_plate_interactive.png" alt="Schematic of a 24-well plate for transfection planning" class="my-2 rounded-lg shadow-md mx-auto block max-w-xs w-auto bg-gray-200 p-2" onerror="this.onerror=null; this.src='https://placehold.co/300x200/e2e8f0/4a5568?text=Placeholder:+24-Well+Plate'; this.alt='Placeholder: 24-Well+Plate';">
                                            <p class="text-xs text-gray-600">Example conditions: Well A1: Untransfected Control, Well A2: pH2B-GFP, Well A3: pRKV-FLAG, Well B1: Both plasmids.</p>
                                        </div>
                                    `
                                },
                                { 
                                    title: "Distribute Precipitate on Plate", 
                                    content: `<h5>Step 9: Gentle Distribution</h5><p class="text-sm">After adding the precipitate to all designated wells, gently swirl the plate in a "figure-eight" motion or rock it back-and-forth and side-to-side a few times to ensure an even distribution of the precipitates over the cell monolayer. Avoid vigorous shaking.</p>`
                                },
                                { 
                                    title: "Incubate Overnight", 
                                    content: `<h5>Step 10: Off to the Incubator</h5><p class="text-sm">Place the plate carefully into the 37°C incubator with 5% CO₂ and incubate overnight (typically 16-24 hours). Some protocols involve changing the medium after 4-6 hours to remove the precipitate and reduce toxicity, but for many robust cell lines like HEK293, overnight incubation is common.</p>`
                                },
                                { 
                                    title: "Observe Cell Morphology", 
                                    content: `<h5>Step 11: Curious Observation</h5>
                                            <p class="text-sm">The next day (or starting a few hours post-transfection), regularly check your cells under a phase-contrast microscope. Note any changes in cell morphology. Calcium phosphate precipitates can sometimes be slightly toxic or stressful to cells, appearing as small, dark granules on or around them. Also, look for signs of contamination.</p>
                                            <img src="placeholder_HEK_cells_CaPi_phase_contrast.jpg" alt="HEK cells under phase contrast after calcium phosphate transfection" class="my-4 rounded-lg shadow-md mx-auto block max-w-full sm:max-w-lg w-auto bg-gray-200 p-4" onerror="this.onerror=null; this.src='https://placehold.co/500x300/e2e8f0/4a5568?text=Placeholder:+HEK+Cells+CaPi'; this.alt='Placeholder: HEK Cells CaPi';">`
                                }
                            ];

                            accordionContainer.innerHTML = ''; // Clear previous items
                            protocolSteps.forEach((step, index) => {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'accordion-item';

                                const headerButton = document.createElement('button');
                                headerButton.className = 'accordion-header';
                                headerButton.innerHTML = `
                                    <span class="step-number">${index + 1}.</span>
                                    <span class="step-title">${step.title}</span>
                                    <span class="accordion-icon text-xl font-light">+</span>
                                `;
                                
                                const contentDiv = document.createElement('div');
                                contentDiv.className = 'accordion-content hidden'; // Content hidden by default
                                contentDiv.innerHTML = step.content;

                                // Initialize Small Volume Quiz (Interactive Box 2) using event delegation if it's this step
                                if (index === 1) { // Index 1 corresponds to "Plasmid Calc." which contains Box 2
                                    const smallVolQuizEl = contentDiv.querySelector('#small-volume-quiz');
                                    const smallVolFeedbackEl = contentDiv.querySelector('#small-volume-feedback');

                                    if (smallVolQuizEl && smallVolFeedbackEl) {
                                        smallVolQuizEl.addEventListener('click', function(event) {
                                            if (event.target.classList.contains('quiz-option')) {
                                                const selectedOptBtn = event.target;
                                                
                                                // Disable all buttons within THIS quiz instance and clear styles
                                                this.querySelectorAll('.quiz-option').forEach(btn => {
                                                    btn.disabled = true;
                                                    btn.classList.remove('correct', 'incorrect');
                                                });

                                                smallVolFeedbackEl.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
                                                const isCorrect = selectedOptBtn.dataset.correct === 'true';

                                                if (isCorrect) {
                                                    selectedOptBtn.classList.add('correct');
                                                    smallVolFeedbackEl.innerHTML = "<strong>Correct!</strong> 0.586 µL is generally too small for accurate direct pipetting. A good strategy is to prepare a master mix or a working dilution.";
                                                    smallVolFeedbackEl.classList.add('bg-green-100', 'text-green-700');
                                                } else {
                                                    selectedOptBtn.classList.add('incorrect');
                                                    smallVolFeedbackEl.innerHTML = "<strong>Not quite.</strong> Volumes this small are prone to significant percentage error with standard pipettes. The better answer is 'No'.";
                                                    smallVolFeedbackEl.classList.add('bg-red-100', 'text-red-700');
                                                    const correctButton = this.querySelector('.quiz-option[data-correct="true"]');
                                                    if (correctButton) correctButton.classList.add('correct');
                                                }
                                                smallVolFeedbackEl.classList.remove('hidden');
                                            }
                                        });
                                    }
                                }


                                headerButton.addEventListener('click', () => {
                                    const isActive = headerButton.classList.contains('active');
                                    if (isActive) {
                                        headerButton.classList.remove('active');
                                        contentDiv.classList.add('hidden');
                                        headerButton.querySelector('.accordion-icon').textContent = '+';
                                    } else {
                                        headerButton.classList.add('active');
                                        contentDiv.classList.remove('hidden');
                                        headerButton.querySelector('.accordion-icon').textContent = '−';
                                    }
                                });

                                itemDiv.appendChild(headerButton);
                                itemDiv.appendChild(contentDiv);
                                accordionContainer.appendChild(itemDiv);
                            });
                        } else {
                             console.warn("Protocol accordion container not found.");
                        }
                        console.log("Module 3 init function finished.");
                    }
                }
            ];

            // --- CORE UI LOGIC ---
            function loadModule(moduleId) {
                console.log("loadModule called for:", moduleId);
                const currentWelcomeMessage = document.getElementById('welcome-message'); 
                const currentMainContent = document.getElementById('main-content'); 

                if (!currentMainContent) {
                    console.error("CRITICAL: mainContent element not found in loadModule. Cannot proceed.");
                    return;
                }

                const moduleData = modulesData.find(m => m.id === moduleId);
                console.log("Found moduleData for " + moduleId + ":", moduleData ? "Yes" : "No");

                if (moduleData) { 
                    if (currentWelcomeMessage) {
                        console.log("Hiding welcome message in loadModule for " + moduleId);
                        currentWelcomeMessage.style.display = 'none'; 
                    }
                    currentMainContent.innerHTML = moduleData.content(); 
                    console.log("Module content injected for:", moduleId);
                    
                    if (moduleData.quiz && moduleData.quiz.length > 0) {
                        console.log("Rendering quiz for:", moduleId);
                        const quizHtml = `
                            <div class="mt-8 pt-6 border-t-2 border-blue-300">
                                <h3 class="text-xl font-semibold text-blue-700 mb-4">Module Quiz!</h3>
                                <p class="text-sm text-gray-600 mb-4">Test your knowledge from this module. Select an answer for each question.</p>
                                <div id="quiz-container-${moduleId}"></div>
                            </div>
                        `;
                        currentMainContent.insertAdjacentHTML('beforeend', quizHtml);
                        renderQuiz(moduleData.quiz, `quiz-container-${moduleId}`);
                    }
                    
                    if (moduleData.init && typeof moduleData.init === 'function') {
                        console.log("Calling init function for:", moduleId);
                        try {
                            moduleData.init(); 
                        } catch (error) {
                            console.error("Error during module initialization for " + moduleId + ":", error);
                        }
                    }

                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        link.classList.remove('active', 'bg-slate-700', 'text-yellow-400');
                        if (link.dataset.moduleId === moduleId) {
                            link.classList.add('active', 'bg-slate-700', 'text-yellow-400');
                        }
                    });
                } else {
                    console.warn(`Module with ID "${moduleId}" not found. Displaying welcome message if available.`);
                    if(currentWelcomeMessage) currentWelcomeMessage.style.display = 'block'; 
                }
            }

            function renderQuiz(quizData, containerId) {
                const quizContainer = document.getElementById(containerId);
                if (!quizContainer) {
                    console.error(`Quiz container with ID "${containerId}" not found.`);
                    return; 
                }
                quizContainer.innerHTML = ''; 

                quizData.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'quiz-question';
                    
                    let optionsHtml = '';
                    if (q.type === 'mcq' || q.type === 'tf') { 
                        q.options.forEach(optionText => {
                            const escapedOptionValue = optionText.replace(/"/g, '&quot;'); 
                            optionsHtml += `<button class="quiz-option" data-question-index="${index}" data-option-value="${escapedOptionValue}">${optionText}</button>`;
                        });
                    }

                    questionDiv.innerHTML = `
                        <p class="font-medium mb-3">${index + 1}. ${q.question}</p>
                        <div class="space-y-2">${optionsHtml}</div>
                        <div class="feedback-message text-sm mt-2 p-2 rounded-md hidden"></div>
                    `;
                    quizContainer.appendChild(questionDiv);
                });

                quizContainer.addEventListener('click', function(event) {
                    if (event.target.classList.contains('quiz-option')) {
                        const selectedOptionButton = event.target;
                        const questionIndex = parseInt(selectedOptionButton.dataset.questionIndex);
                        const questionData = quizData[questionIndex];
                        const feedbackDiv = selectedOptionButton.closest('.quiz-question').querySelector('.feedback-message');
                        const selectedValue = selectedOptionButton.dataset.optionValue;

                        selectedOptionButton.parentElement.querySelectorAll('.quiz-option').forEach(btn => {
                            btn.disabled = true;
                            btn.classList.remove('correct', 'incorrect'); 
                        });
                        
                        feedbackDiv.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700'); 

                        if (selectedValue === questionData.answer) {
                            selectedOptionButton.classList.add('correct');
                            feedbackDiv.innerHTML = '<strong>Correct!</strong> '; 
                            feedbackDiv.classList.add('bg-green-100', 'text-green-700');
                        } else {
                            selectedOptionButton.classList.add('incorrect');
                            feedbackDiv.innerHTML = `<strong>Incorrect.</strong> The correct answer is: <span class="font-semibold">${questionData.answer}</span>. `;
                            feedbackDiv.classList.add('bg-red-100', 'text-red-700');
                            selectedOptionButton.parentElement.querySelectorAll('.quiz-option').forEach(btn => {
                                if (btn.dataset.optionValue === questionData.answer) {
                                    btn.classList.add('correct'); 
                                }
                            });
                        }
                        if(questionData.explanation) {
                            feedbackDiv.innerHTML += `<br><span class="text-xs">${questionData.explanation}</span>`;
                        }
                        feedbackDiv.classList.remove('hidden'); 
                    }
                });
            }

            function populateSidebar() {
                const sidebarEl = document.getElementById('sidebar'); 
                if (!sidebarEl) {
                    console.error("Sidebar element not found for populating.");
                    return;
                }
                const existingLinks = sidebarEl.querySelectorAll('a.sidebar-link');
                existingLinks.forEach(link => link.remove());
                
                console.log("Populating sidebar. Modules available:", modulesData.length, "modulesData:", JSON.stringify(modulesData.map(m=>m.id))); 

                modulesData.forEach(module => {
                    console.log("Processing module for sidebar link:", module.title); 
                    const link = document.createElement('a');
                    link.href = '#'; 
                    link.textContent = module.title;
                    link.className = 'block py-2.5 px-4 rounded sidebar-link text-slate-200 hover:bg-slate-600 hover:text-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-colors duration-150 text-sm';
                    link.dataset.moduleId = module.id;
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        loadModule(module.id);
                    });
                    sidebarEl.appendChild(link);
                    console.log("Added link to sidebar for:", module.title); 
                });
            }
            
            // --- INITIALIZATION ---
            console.log("DOM fully loaded. Starting initial setup.");
            populateSidebar(); 
            
            const welcomeMessageRef = document.getElementById('welcome-message'); 
            if (modulesData.length > 0 && modulesData[0].id === "module3") {
                console.log("Attempting to auto-load Module 3.");
                 if (welcomeMessageRef) { 
                    welcomeMessageRef.style.display = 'none'; 
                    console.log("Welcome message hidden before loading module 3.");
                }
                loadModule("module3");
            } else {
                console.warn("Module 3 not found as the first/only module, or modulesData is empty.");
                if(welcomeMessageRef) {
                    welcomeMessageRef.style.display = 'block'; 
                    console.log("Displaying welcome message as Module 3 was not loaded.");
                }
            }
            console.log("Initial setup finished.");
        });
        console.log("Script execution finished (event listener for DOMContentLoaded is set).");
    </script>
</body>
</html>
